{% extends 'base.html' %}

{% block content %}
<h2>Agenda</h2>

<div id="calendar"></div>
<!-- MODAL -->
<div class="modal fade" id="modalAgendamento" tabindex="-1">
  <div class="modal-dialog">
    <form id="formAgendamento" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Novo Agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="data" id="dataAgendamento">

        <div class="mb-3">
          <label>Cliente</label>
          <select name="cliente" class="form-select" required>
            {% for c in clientes %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label>Procedimento</label>
          <select name="procedimento" class="form-select" required>
            {% for p in procedimentos %}
              <option value="{{ p.id }}">{{ p.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label>Hora</label>
          <input type="time" name="hora" class="form-control" required>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  </div>
</div>
<!-- MODAL EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <form id="formEditar" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="id" id="editarId">

      <div class="modal-header">
        <h5 class="modal-title">Editar Agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label>Hora</label>
          <input type="time" name="hora" id="editarHora" class="form-control">
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" id="btnExcluir" class="btn btn-danger">Excluir</button>
      </div>
    </form>
  </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

    var calendar = new FullCalendar.Calendar(
        document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        events: {{ eventos|safe }},

        dateClick: function(info) {
            document.getElementById('dataAgendamento').value = info.dateStr;
            new bootstrap.Modal(
                document.getElementById('modalAgendamento')
            ).show();
        },

        eventClick: function(info) {
            document.getElementById('editarId').value = info.event.id;
            document.getElementById('editarHora').value =
                info.event.start.toTimeString().slice(0,5);

            new bootstrap.Modal(
                document.getElementById('modalEditar')
            ).show();
        }
    });

    calendar.render();

    // SALVAR NOVO AGENDAMENTO
    document.getElementById('formAgendamento').addEventListener('submit', function(e) {
        e.preventDefault();

        fetch("{% url 'criar_agendamento' %}", {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(r => r.json())
        .then(evento => {
            calendar.addEvent(evento);
            bootstrap.Modal.getInstance(
                document.getElementById('modalAgendamento')
            ).hide();
        });
    });

    // EDITAR AGENDAMENTO
    document.getElementById('formEditar').addEventListener('submit', function(e) {
        e.preventDefault();

        fetch("{% url 'editar_agendamento' %}", {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(() => location.reload());
    });

    // EXCLUIR AGENDAMENTO
    document.getElementById('btnExcluir').addEventListener('click', function() {
        if (!confirm('Excluir este agendamento?')) return;

        var fd = new FormData();
        fd.append('id', document.getElementById('editarId').value);

        fetch("{% url 'excluir_agendamento' %}", {
            method: 'POST',
            body: fd,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(() => location.reload());
    });

});
</script>

{% endblock %}
